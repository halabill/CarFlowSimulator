<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧車道模擬器 (路徑平滑優化版)</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            background-color: #f0f0f0;
            padding: 20px;
            gap: 30px;
        }

        #simulator-container {
            position: relative;
            /* 根據您的圖片尺寸設定 */
            width: 872px; 
            height: 503px;
            /* 嵌入您的地圖圖片為背景 */
            background-image: url('background.png');
            background-size: 100% 100%;
            background-repeat: no-repeat;
            border: 2px solid #333;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .car {
            position: absolute;
            width: 20px;
            height: 38px;
            border: 1px solid black;
            border-radius: 6px;
            /* 移除 transition，因為我們使用 requestAnimationFrame 精確控制 */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.7);
            transform-origin: center center;
            z-index: 10;
        }
        .car::before { /* 車窗 */
            content: ''; width: 80%; height: 40%; margin-top: 4px;
            background: rgba(0,0,0,0.3); border-radius: 3px;
        }

        #car-red { background-color: #e74c3c; }
        #car-yellow { background-color: #f1c40f; }
        
        .traffic-light {
            position: absolute;
            background-color: #2c3e50;
            padding: 4px;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            gap: 3px;
            z-index: 5;
        }
        .light {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background-color: #7f8c8d;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        .light.red.active { background-color: #e74c3c; box-shadow: 0 0 8px #e74c3c; }
        .light.green.active { background-color: #2ecc71; box-shadow: 0 0 8px #2ecc71; }

        /* --- 物件精確定位 --- */
        #traffic-light-1 { top: 425px; left: 200px; }
        #traffic-light-2 { top: 200px; left: 150px; }
        #traffic-light-3 { top: 220px; left: 250px; }

        #control-panel {
            width: 280px; padding: 20px; background-color: #fff;
            border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; gap: 20px;
        }
        #control-panel h3 {
            margin: 0; text-align: center; color: #34495e;
            border-bottom: 1px solid #ddd; padding-bottom: 10px;
        }
        .control-group { display: flex; flex-direction: column; gap: 10px; }
        .control-group label { font-weight: bold; color: #555; }
        .control-group input[type="range"] { width: 100%; }
        .control-group button {
            padding: 10px 15px; font-size: 16px; border: none;
            border-radius: 5px; color: white; cursor: pointer;
            transition: background-color 0.3s;
        }
        .control-group button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        #btn-start-red { background-color: #c0392b; }
        #btn-start-red:hover:not(:disabled) { background-color: #e74c3c; }
        #btn-start-yellow { background-color: #d35400; }
        #btn-start-yellow:hover:not(:disabled) { background-color: #f39c12; }
    </style>
</head>
<body>
    <div id="simulator-container">
        <div id="car-red" class="car"></div>
        <div id="car-yellow" class="car"></div>
        <div id="traffic-light-1" class="traffic-light">
            <div class="light red"></div><div class="light green"></div>
        </div>
        <div id="traffic-light-2" class="traffic-light">
            <div class="light red"></div><div class="light green"></div>
        </div>
        <div id="traffic-light-3" class="traffic-light">
            <div class="light red"></div><div class="light green"></div>
        </div>
    </div>

    <div id="control-panel">
        <h3>智慧車道控制器 (優化版)</h3>
        <div class="control-group">
            <label for="speed-red">紅色車速度: <span id="speed-red-value">5</span></label>
            <input type="range" id="speed-red" min="1" max="10" value="5">
            <button id="btn-start-red">啟動紅色車</button>
        </div>
        <div class="control-group">
            <label for="speed-yellow">黃色車速度: <span id="speed-yellow-value">5</span></label>
            <input type="range" id="speed-yellow" min="1" max="10" value="5">
            <button id="btn-start-yellow">啟動黃色車</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const carRedEl = document.getElementById('car-red');
            const carYellowEl = document.getElementById('car-yellow');
            const lights = {
                '1': { red: document.querySelector('#traffic-light-1 .red'), green: document.querySelector('#traffic-light-1 .green'), state: 'green' },
                '2': { red: document.querySelector('#traffic-light-2 .red'), green: document.querySelector('#traffic-light-2 .green'), state: 'green' },
                '3': { red: document.querySelector('#traffic-light-3 .red'), green: document.querySelector('#traffic-light-3 .green'), state: 'green' }
            };
            const btnStartRed = document.getElementById('btn-start-red');
            const btnStartYellow = document.getElementById('btn-start-yellow');
            const speedSliderRed = document.getElementById('speed-red');
            const speedSliderYellow = document.getElementById('speed-yellow');
            const speedValueRed = document.getElementById('speed-red-value');
            const speedValueYellow = document.getElementById('speed-yellow-value');

            // --- 路徑定義 (高樣本數) ---
            const redPath = [
  { x: 320, y: 350 },
  { x: 280, y: 320 },
  { x: 270, y: 310 },
  { x: 260, y: 280 },
  { x: 240, y: 240 },
  { x: 210, y: 150 },
  { x: 200, y: 140 },
  { x: 190, y: 135 },
  { x: 180, y: 110 },
  { x: 160, y: 130 },
  { x: 130, y: 180 },
  { x: 120, y: 220 },
  { x: 130, y: 260 },
  { x: 150, y: 300 },
  { x: 180, y: 350 },
  { x: 200, y: 400 },
  { x: 200, y: 450 }
];

            const yellowPath = [
  { x: 300, y: 350 },
  { x: 300, y: 300 },
  { x: 290, y: 250 },
  { x: 270, y: 200 },
  { x: 240, y: 160 },
  { x: 200, y: 130 },
  { x: 160, y: 140 },
  { x: 130, y: 180 },
  { x: 120, y: 220 },
  { x: 130, y: 260 },
  { x: 150, y: 300 },
  { x: 180, y: 350 },
  { x: 200, y: 400 },
  { x: 200, y: 450 }
];
            
            let carRed = {
                el: carRedEl, path: redPath, speed: 5, step: 0, active: false, paused: false,
                stopAt: [],
                endTrigger: { step: redPath.length - 3 }
            };
            let carYellow = {
                el: carYellowEl, path: yellowPath, speed: 5, step: 0, active: false, paused: false,
                // 校準後的停車點索引
                stopAt: [{ step: 3, light: '1' }, { step: 8, light: '2' }],
                endTrigger: { step: yellowPath.length - 5 }
            };

            const resetCarState = (car) => {
                car.active = false;
                car.paused = false;
                car.step = 0;
                const { x, y, angle } = car.path[0];
                car.el.style.left = `${x - (car.el.offsetWidth / 2)}px`;
                car.el.style.top = `${y - (car.el.offsetHeight / 2)}px`;
                car.el.style.transform = `rotate(${angle}deg)`;
            };

            function setLightState(lightId, state) {
                const light = lights[lightId];
                light.state = state;
                light.green.classList.toggle('active', state === 'green');
                light.red.classList.toggle('active', state === 'red');
            }

            function setButtonsState(enabled) {
                btnStartRed.disabled = !enabled;
                btnStartYellow.disabled = !enabled;
            }

            function resetSimulation() {
                setButtonsState(true);
                resetCarState(carRed);
                resetCarState(carYellow);
                setLightState('1', 'green');
                setLightState('2', 'green');
                setLightState('3', 'green');
            }

            function moveCar(car) {
                if (!car.active || car.paused) return;

                // 檢查是否需要停車
                for (const stop of car.stopAt) {
                    if (car.step === stop.step && lights[stop.light].state === 'red') {
                        car.paused = true;
                        return; 
                    }
                }

                // 檢查是否到達終點
                if (car.step >= car.path.length - 1) {
                    resetSimulation();
                    return;
                }

                car.step++;
                const { x, y, angle } = car.path[car.step];
                car.el.style.left = `${x - (car.el.offsetWidth / 2)}px`;
                car.el.style.top = `${y - (car.el.offsetHeight / 2)}px`;
                car.el.style.transform = `rotate(${angle}deg)`;

                // 檢查是否通過終點觸發器
                if (car.step >= car.endTrigger.step) {
                    setLightState('1', 'green');
                    setLightState('2', 'green');
                    setLightState('3', 'green');
                }
            }
            
            let animationFrameId;
            let carRedProgress = 0;
            let carYellowProgress = 0;

            function gameLoop(timestamp) {
                if(carRed.active) {
                    carRedProgress += carRed.speed;
                    // 數字越大，速度越慢。調整 50 這個值來改變整體速度感。
                    if(carRedProgress >= 50) {
                        moveCar(carRed);
                        carRedProgress = 0;
                    }
                }

                if(carYellow.active) {
                    carYellowProgress += carYellow.speed;
                    if(carYellowProgress >= 50) {
                        moveCar(carYellow);
                        carYellowProgress = 0;
                    }
                }
                
                animationFrameId = requestAnimationFrame(gameLoop);
            }
            
            function stopGameLoop() {
                 cancelAnimationFrame(animationFrameId);
            }

            function startSimulation(carToStart) {
                resetSimulation();
                setButtonsState(false);
                carToStart.active = true;
                
                if (carToStart === carRed) {
                    setLightState('3', 'green');
                    setLightState('1', 'red');
                    setLightState('2', 'red');
                } else {
                    setLightState('1', 'green');
                    setLightState('2', 'red');
                    setLightState('3', 'red');
                }
            }

            btnStartRed.addEventListener('click', () => startSimulation(carRed));
            btnStartYellow.addEventListener('click', () => startSimulation(carYellow));
            
            speedSliderRed.addEventListener('input', (e) => {
                carRed.speed = parseInt(e.target.value, 10);
                speedValueRed.textContent = carRed.speed;
            });
            speedSliderYellow.addEventListener('input', (e) => {
                carYellow.speed = parseInt(e.target.value, 10);
                speedValueYellow.textContent = carYellow.speed;
            });

            resetSimulation();
            gameLoop();
        });
    </script>
</body>
</html>